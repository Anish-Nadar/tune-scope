<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuneScope - Tuner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1c1c1c;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        .gradient-text {
            background-image: linear-gradient(to right, #f97316, #facc15);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .font-playfair {
            font-family: 'Playfair Display', serif;
        }
        .section-title {
            @apply text-3xl md:text-4xl font-bold text-white mb-8 text-center;
            letter-spacing: -0.025em;
        }
        .card-style {
            @apply block p-6 bg-stone-900/50 rounded-xl shadow-lg border border-transparent hover:bg-stone-800/70 hover:shadow-xl hover:shadow-amber-500/30 hover:border-amber-500/70 transition-all duration-300 ease-in-out transform hover:-translate-y-1;
        }
        .control-button {
            @apply py-3 px-8 rounded-lg font-semibold shadow-md transition-colors duration-300;
        }
        .control-button-primary {
            @apply bg-amber-500 text-stone-900 hover:bg-amber-600 hover:shadow-lg hover:shadow-amber-400/40;
        }
        .control-button-secondary {
            @apply bg-stone-700 text-stone-100 hover:bg-stone-600 hover:shadow-lg hover:shadow-stone-500/40;
        }
        .control-button-danger {
            @apply bg-red-600 text-white hover:bg-red-700 hover:shadow-lg hover:shadow-red-500/40;
        }

        #tuner-display {
            @apply bg-stone-800 p-8 rounded-xl shadow-2xl flex flex-col items-center justify-center min-h-[300px] w-full max-w-lg mx-auto;
        }
        #current-note {
            @apply text-8xl font-extrabold mb-4;
            line-height: 1;
        }
        #frequency-display {
            @apply text-2xl text-stone-300 mb-6 font-medium;
        }
        #cents-display {
            @apply text-4xl font-extrabold mb-8;
        }
        .in-tune { color: #10b981; }
        .sharp { color: #ef4444; }
        .flat { color: #3b82f6; }
        .slightly-sharp { color: #f59e0b; }
        .slightly-flat { color: #f59e0b; }
        .no-pitch { color: #6b7280; }

        #target-strings {
            @apply flex flex-wrap justify-center gap-3 mt-6;
        }
        .target-string-item {
            @apply px-4 py-2 rounded-md text-stone-400 border border-stone-700 text-lg font-medium transition-all duration-200;
            min-width: 60px;
            text-align: center;
        }
        .target-string-item.active-string {
            @apply bg-amber-500 text-stone-900 font-bold border-amber-500 shadow-md shadow-amber-500/30;
        }
        .back-button {
            @apply mt-8 px-6 py-2 bg-stone-700 text-stone-100 rounded-lg hover:bg-stone-600 transition-colors;
        }
        .instrument-icon {
            width: 64px;
            height: 64px;
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }
    </style>
</head>
<body class="bg-stone-950 text-stone-100 antialiased">

    <header class="text-center pt-8 md:pt-12 mb-8">
        <h1 class="text-4xl md:text-5xl font-bold gradient-text">
            TuneScope Tuner
        </h1>
    </header>

    <main class="container mx-auto px-4 py-8">
        <section id="instrument-selection-view" class="flex flex-col items-center">
            <h2 class="section-title">Choose Your Instrument</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
                <button class="card-style flex flex-col items-center justify-center text-center p-8" onclick="selectInstrument('guitar')">
                    <div class="mb-4">
                        <img src="https://placehold.co/64x64/f59e0b/1c1c1c/png?text=GUITAR" alt="Guitar Icon" class="instrument-icon">
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-white mb-1">Guitar</h3>
                        <p class="text-stone-400 text-base">Standard EADGBe tuning.</p>
                    </div>
                </button>
                <button class="card-style flex flex-col items-center justify-center text-center p-8" onclick="selectInstrument('ukulele')">
                    <div class="mb-4">
                        <img src="https://placehold.co/64x64/f59e0b/1c1c1c/png?text=UKULELE" alt="Ukulele Icon" class="instrument-icon">
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-white mb-1">Ukulele</h3>
                        <p class="text-stone-400 text-base">Standard GCEA tuning.</p>
                    </div>
                </button>
                <button class="card-style flex flex-col items-center justify-center text-center p-8" onclick="selectInstrument('bass')">
                    <div class="mb-4">
                        <img src="https://placehold.co/64x64/f59e0b/1c1c1c/png?text=BASS" alt="Bass Icon" class="instrument-icon">
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-white mb-1">Bass</h3>
                        <p class="text-stone-400 text-base">Standard EADG tuning.</p>
                    </div>
                </button>
                <button class="card-style flex flex-col items-center justify-center text-center p-8" onclick="selectInstrument('violin')">
                    <div class="mb-4">
                        <img src="https://placehold.co/64x64/f59e0b/1c1c1c/png?text=VIOLIN" alt="Violin Icon" class="instrument-icon">
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-white mb-1">Violin</h3>
                        <p class="text-stone-400 text-base">Standard GDAE tuning.</p>
                    </div>
                </button>
            </div>
        </section>

        <section id="tuner-view" class="hidden flex flex-col items-center">
            <h2 class="section-title"><span id="instrument-name-display" class="capitalize"></span> Tuner</h2>
            
            <div id="tuner-display">
                <p class="text-stone-300 text-lg mb-2 opacity-80">Detected Note:</p>
                <p id="current-note" class="no-pitch">--</p>
                <p id="frequency-display" class="text-stone-300 text-xl font-medium">-- Hz</p>
                <p id="cents-display" class="no-pitch text-3xl font-bold mt-4">-- cents</p>

                <div id="target-strings" class="mt-8">
                </div>

                <div class="flex flex-col sm:flex-row gap-4 mt-10 w-full justify-center">
                    <button id="start-tuner-button" class="control-button control-button-primary">Start Tuner</button>
                    <button id="stop-tuner-button" class="control-button control-button-danger" disabled>Stop Tuner</button>
                </div>
            </div>
            <button class="back-button text-lg" onclick="backToSelection()">‚Üê Change Instrument</button>
        </section>
    </main>

    <script>
        let audioContext;
        let analyserNode;
        let mediaStreamSource;
        let animationFrameId;
        let isDetecting = false;
        let selectedInstrument = null;
        let currentTargetStringMidi = null;

        const A4_FREQ = 440;
        const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const C0_MIDI = 12;

        const instrumentTunings = {
            'guitar': [40, 45, 50, 55, 59, 64],
            'ukulele': [67, 60, 64, 69],
            'bass': [28, 33, 38, 43],
            'violin': [55, 62, 69, 76]
        };

        const instrumentSelectionView = document.getElementById('instrument-selection-view');
        const tunerVew = document.getElementById('tuner-view');
        const instrumentNameDisplay = document.getElementById('instrument-name-display');
        const currentNoteDisplay = document.getElementById('current-note');
        const frequencyDisplay = document.getElementById('frequency-display');
        const centsDisplay = document.getElementById('cents-display');
        const targetStringsContainer = document.getElementById('target-strings');
        const startTunerButton = document.getElementById('start-tuner-button');
        const stopTunerButton = document.getElementById('stop-tuner-button');

        function showView(viewId) {
            instrumentSelectionView.classList.add('hidden');
            tunerVew.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function selectInstrument(instrument) {
            selectedInstrument = instrument;
            instrumentNameDisplay.textContent = instrument.charAt(0).toUpperCase() + instrument.slice(1);
            loadTargetStrings(instrument);
            showView('tuner-view');
        }

        function backToSelection() {
            stopPitchDetection();
            selectedInstrument = null;
            showView('instrument-selection-view');
            resetTunerDisplay();
        }

        function loadTargetStrings(instrument) {
            targetStringsContainer.innerHTML = '';
            const tunings = instrumentTunings[instrument];
            if (tunings) {
                tunings.forEach(midiNote => {
                    const noteName = midiToNoteName(midiNote);
                    const span = document.createElement('span');
                    span.classList.add('target-string-item');
                    span.textContent = noteName;
                    span.dataset.midi = midiNote;
                    targetStringsContainer.appendChild(span);
                });
            }
        }

        function highlightTargetString(midiNote) {
            const targetStringItems = document.querySelectorAll('.target-string-item');
            targetStringItems.forEach(item => {
                item.classList.remove('active-string');
                if (parseInt(item.dataset.midi) === midiNote) {
                    item.classList.add('active-string');
                }
            });
        }

        function resetTunerDisplay() {
            currentNoteDisplay.textContent = '--';
            currentNoteDisplay.className = 'text-8xl font-extrabold mb-4 gradient-text no-pitch';
            frequencyDisplay.textContent = '-- Hz';
            centsDisplay.textContent = '-- cents';
            centsDisplay.className = 'text-3xl font-bold mt-4 no-pitch';
            highlightTargetString(null);
        }

        async function startPitchDetection() {
            if (isDetecting) return;

            startTunerButton.disabled = true;
            stopTunerButton.disabled = false;
            isDetecting = true;
            resetTunerDisplay();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false } });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                analyserNode = audioContext.createAnalyser();
                analyserNode.fftSize = 2048;
                analyserNode.minDecibels = -90;
                analyserNode.maxDecibels = -10;
                analyserNode.smoothingTimeConstant = 0.8;

                mediaStreamSource = audioContext.createMediaStreamSource(stream);
                mediaStreamSource.connect(analyserNode);

                pitchDetectionLoop();

            } catch (error) {
                console.error('Microphone access error:', error);
                alert('Could not access your microphone. Please ensure it is connected and permissions are granted.');
                stopPitchDetection();
            }
        }

        function stopPitchDetection() {
            if (!isDetecting) return;

            cancelAnimationFrame(animationFrameId);

            if (mediaStreamSource) {
                mediaStreamSource.disconnect();
                if (mediaStreamSource.mediaStream) {
                    mediaStreamSource.mediaStream.getTracks().forEach(track => track.stop());
                }
            }

            if (audioContext) {
                audioContext.close().then(() => {
                    console.log("AudioContext closed.");
                });
            }

            startTunerButton.disabled = false;
            stopTunerButton.disabled = true;
            isDetecting = false;
            resetTunerDisplay();
        }

        function getPitch(audioBuffer, sampleRate) {
            const bufferSize = audioBuffer.length;
            const MIN_DETECTABLE_FREQUENCY = 60;
            const MAX_DETECTABLE_FREQUENCY = 1200;
            const MAX_SAMPLES = Math.floor(sampleRate / MIN_DETECTABLE_FREQUENCY);
            const GOOD_ENOUGH_CORRELATION = 0.9;

            let bestCorrelation = -1;
            let bestOffset = -1;
            let currentCorrelation;

            let rms = 0;
            for (let i = 0; i < bufferSize; i++) {
                rms += audioBuffer[i] * audioBuffer[i];
            }
            rms = Math.sqrt(rms / bufferSize);

            if (rms < 0.01) {
                return 0;
            }

            for (let offset = 0; offset < MAX_SAMPLES; offset++) {
                currentCorrelation = 0;
                for (let i = 0; i < bufferSize - offset; i++) {
                    currentCorrelation += audioBuffer[i] * audioBuffer[i + offset];
                }

                if (currentCorrelation > GOOD_ENOUGH_CORRELATION) {
                    bestCorrelation = currentCorrelation;
                    bestOffset = offset;
                    break;
                }

                if (currentCorrelation > bestCorrelation) {
                    bestCorrelation = currentCorrelation;
                    bestOffset = offset;
                }
            }

            if (bestOffset === -1 || bestOffset === 0) return 0;

            const frequency = sampleRate / bestOffset;

            if (frequency < MIN_DETECTABLE_FREQUENCY || frequency > MAX_DETECTABLE_FREQUENCY) {
                return 0;
            }

            return frequency;
        }

        function frequencyToMidi(frequency) {
            if (frequency === 0) return null;
            return 12 * (Math.log(frequency / A4_FREQ) / Math.log(2)) + 69;
        }

        function midiToNoteName(midiNote) {
            const noteIndex = (midiNote % 12 + 12) % 12;
            const octave = Math.floor(midiNote / 12) - 1;
            return `${NOTE_NAMES[noteIndex]}${octave}`;
        }

        function pitchDetectionLoop() {
            if (!isDetecting) return;

            const bufferLength = analyserNode.fftSize;
            const dataArray = new Float32Array(bufferLength);
            analyserNode.getFloatTimeDomainData(dataArray);

            const detectedFrequency = getPitch(dataArray, audioContext.sampleRate);

            let detectedMidiNote = null;
            let noteText = '--';
            let hertzText = '-- Hz';
            let centsText = '-- cents';
            let centsClass = 'no-pitch';
            let activeTargetStringMidi = null;

            if (detectedFrequency > 0) {
                detectedMidiNote = frequencyToMidi(detectedFrequency);
                if (detectedMidiNote !== null) {
                    const roundedMidiNote = Math.round(detectedMidiNote);
                    const noteIndex = (roundedMidiNote % 12 + 12) % 12;
                    const octave = Math.floor(roundedMidiNote / 12) - 1;

                    noteText = `${NOTE_NAMES[noteIndex]}${octave}`;
                    hertzText = `${detectedFrequency.toFixed(2)} Hz`;

                    const targetTunings = instrumentTunings[selectedInstrument];
                    if (targetTunings && targetTunings.length > 0) {
                        let closestTargetMidi = null;
                        let minCentsDiff = Infinity;

                        targetTunings.forEach(targetMidi => {
                            const targetFreq = A4_FREQ * Math.pow(2, (targetMidi - 69) / 12);
                            const centsDiff = 1200 * Math.log2(detectedFrequency / targetFreq);

                            if (Math.abs(roundedMidiNote - targetMidi) <= 7) {
                                if (Math.abs(centsDiff) < Math.abs(minCentsDiff)) {
                                    minCentsDiff = centsDiff;
                                    closestTargetMidi = targetMidi;
                                }
                            }
                        });

                        if (closestTargetMidi !== null) {
                            centsText = `${minCentsDiff.toFixed(2)} cents`;
                            activeTargetStringMidi = closestTargetMidi;

                            if (Math.abs(minCentsDiff) <= 5) {
                                centsClass = 'in-tune';
                            } else if (minCentsDiff > 5 && minCentsDiff <= 25) {
                                centsClass = 'slightly-sharp';
                            } else if (minCentsDiff < -5 && minCentsDiff >= -25) {
                                centsClass = 'slightly-flat';
                            } else if (minCentsDiff > 25) {
                                centsClass = 'sharp';
                            } else {
                                centsClass = 'flat';
                            }
                        }
                    }
                }
            }

            currentNoteDisplay.textContent = noteText;
            currentNoteDisplay.className = `text-8xl font-extrabold mb-4 gradient-text ${centsClass}`;
            frequencyDisplay.textContent = hertzText;
            centsDisplay.textContent = centsText;
            centsDisplay.className = `text-3xl font-bold mt-4 ${centsClass}`;

            highlightTargetString(activeTargetStringMidi);

            animationFrameId = requestAnimationFrame(pitchDetectionLoop);
        }

        startTunerButton.addEventListener('click', startPitchDetection);
        stopTunerButton.addEventListener('click', stopPitchDetection);

        window.onload = () => {
            showView('instrument-selection-view');
        };
    </script>
</body>
</html>